# 云-边协同多车充电调度强化学习方案

## 数据与环境假设
- **轨迹数据** (`dataset/traj_data/`): 提供EV每5分钟一条的位置，经纬度用于计算Haversine距离与续航消耗。
- **调度点数据** (`dataset/dispatch_points_400.csv`): 边缘可调度的移动充电车（MCS）候选停靠/服务点。
- **FCS Voronoi区域数据** (`dataset/fcs_voronoi_regions.geojson`): 依据固定充电站划分的服务区域，用于映射车辆当前位置到区域，并限制可选调度点与FCS。

## EV仿真逻辑
1. 按轨迹顺序每5分钟更新一次车辆状态，使用上一点与下一点的Haversine距离估算能耗，更新SOC。
2. 当SOC低于阈值（例如20%）时，在当前Voronoi区域发起充电请求。
3. 车辆在区域内选择**最近的调度点或FCS**进行充电；若存在派遣中的MCS，等待或加入队列。

## 双层强化学习结构
### 边缘层（区域级，近端决策）
- **目标**: 最小化本区域请求的等待时间并提高服务成功率。
- **状态** `s_edge`：
  - 区域内待服务/在途车辆数、平均/最大等待时间。
  - 区域内可用MCS数量及其位置、剩余电量/续航。
  - 近期请求到达率、时间片（高峰/平峰）。
- **动作** `a_edge`：在2 km范围内为每个新请求选择调度点（或FCS）；若无可用点，排队或触发跨区请求。
- **奖励** `r_edge`：
  - 成功服务给予正奖励；等待时间、超时取消、空驶距离给予负奖励。
  - 可以对能耗或跨区调用增加惩罚以鼓励就近服务。
- **算法**：可选DQN/DDPG/PPO；状态连续且动作离散（候选点集合），可使用注意力或指针网络对可变候选集合编码。
- **训练**：每个区域本地收集交互，周期性向云端上传轨迹（状态、动作、奖励）。

### 云端层（全局协调）
- **目标**: 在已有边缘策略基础上调配各区域MCS数量/初始部署位置，使全局成功率高、等待时间低。
- **状态** `s_cloud`：
  - 每个区域的历史服务成功率、平均等待时间、请求到达率。
  - 区域间距离/流动趋势（可由轨迹跨区域统计得到）。
  - 当前各区域MCS库存及可调拨数量。
- **动作** `a_cloud`：周期性（例如每小时）调整区域间MCS分配数量或初始驻扎点；可附带“跨区支援阈值”参数。
- **奖励** `r_cloud`：
  - 全局成功率提升、总体等待时间下降给予正奖励；调拨次数/行驶成本给予惩罚。
- **算法**：多步PPO或Actor-Critic，动作可以是连续（比例）或离散（整数调拨）。
- **训练流程**：
  1. 边缘层固定一轮策略收集区域级绩效摘要。
  2. 云端基于摘要更新调拨策略；下发新的MCS配额或驻扎策略。
  3. 新配额在区域环境中生效，继续迭代至指标收敛。

## 训练与评估流程
1. **环境搭建**：
   - 用轨迹数据驱动模拟器，5分钟步长，依据Voronoi多边形定位区域。
   - 构建调度点/FCS KD-tree或球面索引，加速距离计算与动作可行性筛选。
2. **边缘训练**：
   - 每区域独立实例化环境+策略；使用经验回放或GAE。按固定步数同步上传摘要到云端。
3. **云端训练**：
   - 以区域摘要为状态，模拟调拨后的下一周期性能（可用队列模拟或小模型预测）。
   - 用强化学习更新调拨策略。
4. **评估指标**：
   - 成功率（完成充电/服务请求占比）。
   - 平均/95分位等待时间。
   - MCS平均空驶距离与调拨频率。

## 关键实现要点
- **区域映射**：使用Voronoi多边形包含判断或R-tree索引；支持跨区域移动统计。
- **动作裁剪**：为每个请求动态生成2 km内调度点/FCS列表，若为空则允许“跨区支援”或“等待”动作。
- **并行模拟**：多区域环境可并行rollout，节省训练时间。
- **参数共享**：相似区域可共享边缘策略（多头网络），减少数据需求。
- **日志与监控**：记录每次请求的等待时间、服务结果与被调度的MCS/站点，用于离线分析与奖励设计迭代。

## 下一步工作
- 编写轨迹驱动的仿真器组件，输出区域级请求流与队列状态。
- 实现边缘层策略网络与训练管线，并提供云端摘要接口。
- 搭建云端调拨强化学习器，周期性下发配额并与边缘层联动评估。

## Python实现骨架
- `rl_mcs/config.py` 定义仿真/训练/云边超参的dataclass，便于统一读取。
- `rl_mcs/geo.py` 提供Haversine距离、Voronoi区域加载与定位、半径内候选点筛选。
- `rl_mcs/data.py`/`rl_mcs/ev.py` 负责轨迹读取、能耗估算与EV按5分钟步长生成充电请求。
- `rl_mcs/edge_env.py` 描述区域级排队环境、观测与基于候选调度点的动作接口，并输出上传到云端的RegionSummary。
- `rl_mcs/cloud_env.py` 接收区域摘要，基于跨区调拨动作计算奖励，提供基线`greedy_action`。
- `rl_mcs/agents.py` 给出轻量级边缘/云端策略接口与简单基线`act`实现，预留`update`用于接入RL算法。
- `rl_mcs/trainer.py` 协调多区域rollout、缓冲区收集与周期性的策略更新钩子。
- `rl_mcs/simulation_runner.py` 组装上述组件，加载数据后先将EV请求推入区域队列，再进入训练循环，便于后续替换真正的策略/评估逻辑。
